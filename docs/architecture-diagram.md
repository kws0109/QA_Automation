# 시스템 아키텍처

QA Automation Tool의 전체 시스템 구조 및 데이터 흐름

---

## 시스템 전체 구조

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              사용자 (QA 담당자)                           │
└─────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           Frontend (React)                               │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐      │
│  │ 시나리오  │ │ 디바이스  │ │ 실행센터  │ │  리포트  │ │  스케줄  │      │
│  │  에디터   │ │  관리    │ │          │ │  뷰어   │ │  관리   │      │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘      │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    Context (상태 관리)                           │    │
│  │  Auth │ Device │ Execution │ FlowEditor │ ScenarioEditor │ UI   │    │
│  └─────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
                         │                    ▲
                         │ HTTP/WebSocket     │ 실시간 이벤트
                         ▼                    │
┌─────────────────────────────────────────────────────────────────────────┐
│                          Backend (Express)                               │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │                         Routes (API)                              │   │
│  │  auth │ device │ session │ scenario │ test │ report │ schedule   │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                      │                                   │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │                       Services (비즈니스 로직)                    │   │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐      │   │
│  │  │ testOrchestrator│  │  testExecutor  │  │ suiteExecutor  │      │   │
│  │  │   (큐/디스패치)  │  │   (실행 엔진)  │  │  (Suite 실행)  │      │   │
│  │  └────────────────┘  └────────────────┘  └────────────────┘      │   │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐      │   │
│  │  │ sessionManager │  │ deviceManager  │  │  imageMatch    │      │   │
│  │  │ (Appium 세션)  │  │ (ADB 디바이스) │  │ (이미지 매칭)  │      │   │
│  │  └────────────────┘  └────────────────┘  └────────────────┘      │   │
│  └──────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          Appium Server                                   │
│                         (포트: 4900)                                     │
└─────────────────────────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      Android 디바이스 / 에뮬레이터                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐               │
│  │ Device 1 │  │ Device 2 │  │ Device 3 │  │    ...   │               │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘               │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 테스트 실행 흐름

```
┌──────────┐     ┌───────────────────┐     ┌─────────────────┐
│  Client  │────▶│  testOrchestrator │────▶│  testQueueService│
│(Frontend)│     │                   │     │    (대기열)      │
└──────────┘     └───────────────────┘     └─────────────────┘
                          │                         │
                          │ 디스패치                │ 큐에서 꺼냄
                          ▼                         ▼
                 ┌───────────────────┐     ┌─────────────────┐
                 │   testExecutor    │◀────│  deviceManager  │
                 │   (실행 엔진)      │     │ (디바이스 상태) │
                 └───────────────────┘     └─────────────────┘
                          │
          ┌───────────────┼───────────────┐
          ▼               ▼               ▼
   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
   │   Actions   │ │ imageMatch  │ │ textMatcher │
   │(tap,swipe..)│ │ (템플릿매칭)│ │   (OCR)     │
   └─────────────┘ └─────────────┘ └─────────────┘
          │
          ▼
   ┌─────────────┐
   │sessionManager│
   │(Appium 세션) │
   └─────────────┘
          │
          ▼
   ┌─────────────┐
   │   Appium    │
   │   Server    │
   └─────────────┘
          │
          ▼
   ┌─────────────┐
   │   Device    │
   └─────────────┘
```

---

## 데이터 흐름: 시나리오 실행

```
1. 실행 요청
   Client ──POST /api/test/execute──▶ Backend

2. 큐 등록
   testOrchestrator ──enqueue──▶ testQueueService

3. 디바이스 확인
   testQueueService ──checkAvailable──▶ deviceManager

4. 실행 디스패치
   testQueueService ──dispatch──▶ testExecutor

5. 노드 순회
   testExecutor ──forEach node──▶ Actions

6. 디바이스 명령
   Actions ──execute──▶ sessionManager ──▶ Appium ──▶ Device

7. 결과 브로드캐스트
   testExecutor ──emit──▶ Socket.IO ──▶ All Clients

8. 리포트 저장
   testExecutor ──save──▶ testReportService
```

---

## Context 구조 (Frontend)

```
┌─────────────────────────────────────────────────────────────────┐
│                        App.tsx                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                     AuthContext                            │  │
│  │  • user                                                    │  │
│  │  • isAuthenticated                                         │  │
│  │  • login() / logout()                                      │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │                  DeviceContext                       │  │  │
│  │  │  • devices (10초 폴링)                               │  │  │
│  │  │  • sessions                                          │  │  │
│  │  │  • startSession() / stopSession()                    │  │  │
│  │  │  ┌───────────────────────────────────────────────┐  │  │  │
│  │  │  │              ExecutionContext                  │  │  │  │
│  │  │  │  • queueStatus (3초 폴링)                      │  │  │  │
│  │  │  │  • executeTest()                               │  │  │  │
│  │  │  │  • stopExecution()                             │  │  │  │
│  │  │  │  ┌─────────────────────────────────────────┐  │  │  │  │
│  │  │  │  │            UIContext                     │  │  │  │  │
│  │  │  │  │  • activeTab                             │  │  │  │  │
│  │  │  │  │  • modals (open/close)                   │  │  │  │  │
│  │  │  │  │  ┌───────────────────────────────────┐  │  │  │  │  │
│  │  │  │  │  │       FlowEditorContext           │  │  │  │  │  │
│  │  │  │  │  │  • nodes / connections            │  │  │  │  │  │
│  │  │  │  │  │  • selectedNode                   │  │  │  │  │  │
│  │  │  │  │  │  • addNode() / updateNode()       │  │  │  │  │  │
│  │  │  │  │  │  ┌─────────────────────────────┐  │  │  │  │  │  │
│  │  │  │  │  │  │   ScenarioEditorContext     │  │  │  │  │  │  │
│  │  │  │  │  │  │  • scenarios / packages     │  │  │  │  │  │  │
│  │  │  │  │  │  │  • templates                │  │  │  │  │  │  │
│  │  │  │  │  │  │  • save() / load()          │  │  │  │  │  │  │
│  │  │  │  │  │  └─────────────────────────────┘  │  │  │  │  │  │
│  │  │  │  │  └───────────────────────────────────┘  │  │  │  │  │
│  │  │  │  └─────────────────────────────────────────┘  │  │  │  │
│  │  │  └───────────────────────────────────────────────┘  │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 서비스 의존성 (Backend)

```
┌─────────────────────────────────────────────────────────────────┐
│                        index.ts (Entry)                          │
└─────────────────────────────────────────────────────────────────┘
                               │
        ┌──────────────────────┼──────────────────────┐
        ▼                      ▼                      ▼
┌───────────────┐      ┌───────────────┐      ┌───────────────┐
│    Routes     │      │  Middleware   │      │   Socket.IO   │
└───────────────┘      └───────────────┘      └───────────────┘
        │                      │                      │
        └──────────────────────┼──────────────────────┘
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                         Services                                 │
│                                                                  │
│  ┌─────────────────┐         ┌─────────────────┐                │
│  │ testOrchestrator│────────▶│ testQueueService│                │
│  └─────────────────┘         └─────────────────┘                │
│           │                                                      │
│           ▼                                                      │
│  ┌─────────────────┐         ┌─────────────────┐                │
│  │  testExecutor   │────────▶│ sessionManager  │                │
│  └─────────────────┘         └─────────────────┘                │
│           │                          │                           │
│           │                          ▼                           │
│           │                  ┌─────────────────┐                │
│           │                  │  deviceManager  │                │
│           │                  └─────────────────┘                │
│           │                                                      │
│           ├─────────────────────────────────────┐                │
│           ▼                                     ▼                │
│  ┌─────────────────┐                   ┌─────────────────┐      │
│  │   imageMatch    │                   │   textMatcher   │      │
│  └─────────────────┘                   └─────────────────┘      │
│                                                                  │
│  ┌─────────────────┐         ┌─────────────────┐                │
│  │testReportService│────────▶│reportExporter   │                │
│  └─────────────────┘         └─────────────────┘                │
│           │                          │                           │
│           │                          ▼                           │
│           │                  ┌─────────────────┐                │
│           └─────────────────▶│   r2Uploader    │                │
│                              └─────────────────┘                │
│                                                                  │
│  ┌─────────────────┐         ┌─────────────────┐                │
│  │ scheduleManager │────────▶│  suiteExecutor  │                │
│  └─────────────────┘         └─────────────────┘                │
│                                      │                           │
│                                      ▼                           │
│                              ┌─────────────────┐                │
│                              │slackNotification│                │
│                              └─────────────────┘                │
└─────────────────────────────────────────────────────────────────┘
```

---

## 외부 서비스 연동

```
┌─────────────────────────────────────────────────────────────────┐
│                         Backend                                  │
└─────────────────────────────────────────────────────────────────┘
        │              │              │              │
        ▼              ▼              ▼              ▼
┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐
│  Appium   │  │  Slack    │  │  Google   │  │Cloudflare │
│  Server   │  │   API     │  │  Vision   │  │    R2     │
├───────────┤  ├───────────┤  ├───────────┤  ├───────────┤
│ 디바이스   │  │ OAuth     │  │ OCR 인식  │  │ 리포트    │
│ 자동화    │  │ Webhook   │  │           │  │ 공유      │
└───────────┘  └───────────┘  └───────────┘  └───────────┘
```

---

## 데이터 저장 구조

```
game-automation-tool/
├── backend/
│   ├── scenarios/           # 시나리오 JSON
│   │   └── {scenarioId}.json
│   │
│   ├── packages/            # 패키지 JSON
│   │   └── {packageId}.json
│   │
│   ├── suites/              # Suite JSON
│   │   └── {suiteId}.json
│   │
│   ├── templates/           # 이미지 템플릿
│   │   └── {packageId}/
│   │       └── {templateId}.png
│   │
│   ├── devices/             # 저장된 디바이스 정보
│   │   └── {deviceId}.json
│   │
│   ├── schedules/           # 스케줄 JSON
│   │   └── {scheduleId}.json
│   │
│   └── reports/             # 테스트 리포트
│       ├── {reportId}.json
│       ├── screenshots/
│       │   └── {reportId}/
│       │       └── {deviceId}/
│       │           ├── step_1.png
│       │           └── step_1.webp  # 썸네일
│       └── videos/
│           └── {reportId}/
│               └── {deviceId}.mp4
```

---

## 네트워크 포트

| 포트 | 서비스 | 설명 |
|------|--------|------|
| 3001 | Backend | Express API + Socket.IO |
| 5173 | Frontend | Vite 개발 서버 |
| 4900 | Appium | Appium 서버 |
| 9100+ | MJPEG | 디바이스별 스트림 (동적 할당) |

---

## 인증 흐름

### Slack OAuth

```
┌────────┐     ┌────────┐     ┌────────┐     ┌────────┐
│ Client │     │Backend │     │ Slack  │     │ Client │
└───┬────┘     └───┬────┘     └───┬────┘     └───┬────┘
    │              │              │              │
    │ GET /auth/slack             │              │
    │─────────────▶│              │              │
    │              │              │              │
    │  302 Redirect to Slack      │              │
    │◀─────────────│              │              │
    │              │              │              │
    │ 사용자 인증 (Slack 화면)     │              │
    │─────────────────────────────▶              │
    │              │              │              │
    │ Callback with code          │              │
    │◀─────────────────────────────              │
    │              │              │              │
    │ GET /auth/slack/callback    │              │
    │─────────────▶│              │              │
    │              │              │              │
    │              │ Exchange code for token     │
    │              │─────────────▶│              │
    │              │              │              │
    │              │ User info    │              │
    │              │◀─────────────│              │
    │              │              │              │
    │ Set JWT Cookie, Redirect    │              │
    │◀─────────────│              │              │
    │              │              │              │
    │ 인증 완료 (프론트엔드)       │              │
    │─────────────────────────────────────────────▶
```

---

## 스케줄 실행 흐름

```
┌─────────────────┐
│  scheduleManager│ (node-cron)
└────────┬────────┘
         │ Cron 트리거
         ▼
┌─────────────────┐
│ scheduleService │
└────────┬────────┘
         │ Suite 조회
         ▼
┌─────────────────┐
│  suiteExecutor  │
└────────┬────────┘
         │ 시나리오별 실행
         ▼
┌─────────────────┐
│  testExecutor   │
└────────┬────────┘
         │ 완료
         ▼
┌─────────────────┐
│slackNotification│ (결과 알림)
└─────────────────┘
```

---

## WebSocket 이벤트 흐름

```
┌──────────┐                    ┌──────────┐                    ┌──────────┐
│ Client A │                    │  Server  │                    │ Client B │
└────┬─────┘                    └────┬─────┘                    └────┬─────┘
     │                               │                               │
     │ connect                       │                               │
     │──────────────────────────────▶│                               │
     │                               │                               │
     │                               │◀──────────────────────────────│
     │                               │ connect                       │
     │                               │                               │
     │ execute test                  │                               │
     │──────────────────────────────▶│                               │
     │                               │                               │
     │                               │ test:progress (broadcast)     │
     │◀──────────────────────────────│──────────────────────────────▶│
     │                               │                               │
     │                               │ test:step (broadcast)         │
     │◀──────────────────────────────│──────────────────────────────▶│
     │                               │                               │
     │                               │ test:complete (broadcast)     │
     │◀──────────────────────────────│──────────────────────────────▶│
```

---

## 병렬 실행 구조

```
┌────────────────────────────────────────────────────────────────┐
│                     testOrchestrator                            │
└────────────────────────────────────────────────────────────────┘
                              │
           ┌──────────────────┼──────────────────┐
           ▼                  ▼                  ▼
    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │ Device 1    │    │ Device 2    │    │ Device 3    │
    │ Queue       │    │ Queue       │    │ Queue       │
    └──────┬──────┘    └──────┬──────┘    └──────┬──────┘
           │                  │                  │
           ▼                  ▼                  ▼
    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │testExecutor │    │testExecutor │    │testExecutor │
    │ Instance 1  │    │ Instance 2  │    │ Instance 3  │
    └──────┬──────┘    └──────┬──────┘    └──────┬──────┘
           │                  │                  │
           ▼                  ▼                  ▼
    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │  Session 1  │    │  Session 2  │    │  Session 3  │
    │(Appium Port)│    │(Appium Port)│    │(Appium Port)│
    └─────────────┘    └─────────────┘    └─────────────┘
```

---

*최종 수정일: 2026-01-30*
