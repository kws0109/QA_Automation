# 노드 복사/붙여넣기 및 검색 기능 회고록

## 개요

**날짜**: 2026년 1월 29일
**목표**: 플로우 에디터에서 노드 다중 선택, 복사/붙여넣기/복제, 검색 기능 구현

---

## 배경

시나리오 편집 시 반복적인 노드 패턴을 효율적으로 재사용하기 위해 복사/붙여넣기 기능이 필요했습니다. 특히 다른 시나리오에서 작성한 노드 그룹을 가져오거나, 동일한 패턴을 여러 번 사용하는 경우에 유용합니다.

또한 노드가 300개 가까이 되는 대규모 시나리오에서 에러 발생 시 해당 노드를 찾기 어려워 검색 기능이 필요했습니다.

---

## 구현 내용

### 1. 다중 노드 선택

| 조작 | 동작 |
|------|------|
| Shift + 클릭 | 선택에 추가/제거 (토글) |
| Ctrl + 클릭 | 선택에 추가/제거 (토글) |
| Ctrl + A | 모든 노드 선택 |
| Escape | 선택 해제 |
| Delete | 선택된 노드 삭제 |

**상태 관리**: `selectedNodeIds: Set<string>` - 기존 단일 선택(`selectedNodeId`)에서 다중 선택으로 확장

### 2. 복사/붙여넣기 (Ctrl+C / Ctrl+V)

```typescript
// 복사 시 저장되는 데이터 구조
interface ClipboardData {
  nodes: FlowNode[];          // 선택된 노드들
  connections: Connection[];  // 노드 간 내부 연결선만
  copiedAt: number;           // 복사 시점 타임스탬프
}
```

**핵심 로직**:
1. 선택된 노드 간의 연결선만 필터링 (`getInternalConnections`)
2. localStorage에 저장하여 시나리오 간 복사 지원
3. 붙여넣기 시 ID 자동 재생성 (`regenerateIds`)

### 3. 노드 사이에 삽입 (Ctrl+V 개선)

단일 노드 선택 후 Ctrl+V 시 해당 노드 **뒤에** 삽입됩니다.

| 상황 | 동작 |
|------|------|
| 단일 노드 선택 → Ctrl+V | 선택된 노드 뒤에 삽입 (연결선 자동 재연결) |
| 다중 노드 선택 → Ctrl+V | 맨 오른쪽에 배치 |
| 선택 없음 → Ctrl+V | 맨 오른쪽에 배치 |

**예시:**
```
A → B → C  (B 선택 후 Ctrl+V로 X 붙여넣기)
    ↓
A → B → X → C
```

**로직**:
1. 선택된 노드의 outgoing 연결 찾기
2. 붙여넣은 노드의 입구 노드를 선택된 노드에 연결
3. 붙여넣은 노드의 출구 노드를 원래 타겟에 연결
4. 기존 연결 제거

### 4. 복제 (Ctrl+D)

선택된 노드를 원본 오른쪽에 복제하고 자동 정렬합니다.

### 5. 노드 자동 정렬

BFS(너비 우선 탐색) 알고리즘으로 start 노드부터 연결 순서대로 노드를 배치합니다.

**배치 규칙**:
- X 간격: 250px
- Y 간격: 120px
- 시작 위치: (100, 100)

### 6. 시나리오 간 복사

localStorage 키 `qa_automation_clipboard`로 클립보드 데이터를 저장하여 다른 시나리오에서도 붙여넣기 가능합니다.

### 7. 노드 검색 기능

Canvas 상단에 검색창을 추가하여 대규모 시나리오에서 노드를 빠르게 찾을 수 있습니다.

**검색 대상**:
| 대상 | 예시 |
|------|------|
| 노드 ID | `node_1234567890` |
| 라벨 | `로그인 버튼 클릭` |
| 액션 타입 | `tap`, `swipe`, `waitUntilImage` |
| 텍스트 | 입력 텍스트 내용 |

**사용법**:
- 검색창에 검색어 입력
- 결과 클릭 → 해당 노드로 스크롤 및 선택
- Enter: 첫 번째 결과 선택
- Escape: 검색 닫기

---

## 영향 받는 파일

```
frontend/src/types/node.ts                - ClipboardData 타입 추가
frontend/src/contexts/FlowEditorContext.tsx - 다중 선택, 복사/붙여넣기, 삽입 로직
frontend/src/components/Canvas/Canvas.tsx   - 다중 선택 UI, 노드 검색 UI
frontend/src/components/Canvas/Canvas.css   - 다중 선택, 검색 스타일
backend/src/services/screenStreamService.ts - 디바이스 연결 끊김 감지
```

---

## 사용 방법

### 다중 선택
1. 첫 번째 노드 클릭 (선택)
2. Shift 또는 Ctrl 누른 채로 추가 노드 클릭
3. 선택된 노드는 파란색 테두리로 표시

### 복사/붙여넣기
1. 복사할 노드들 선택
2. Ctrl+C로 복사
3. (다른 시나리오로 이동 가능)
4. Ctrl+V로 붙여넣기
5. 새 노드들이 자동 정렬되어 추가됨

### 노드 사이에 삽입
1. 삽입할 위치의 앞 노드 **하나만** 선택
2. Ctrl+V로 붙여넣기
3. 선택된 노드 뒤에 삽입되고 연결선 자동 재연결

### 복제
1. 복제할 노드들 선택
2. Ctrl+D로 복제
3. 원본 오른쪽에 복제된 노드들이 정렬되어 나타남

### 노드 검색
1. Canvas 상단 검색창에 노드 ID, 라벨, 액션 등 입력
2. 결과 목록에서 원하는 노드 클릭
3. 해당 노드로 자동 스크롤 및 선택

---

## 추가 개선 사항

### 스크린 스트림 안정성 개선

디바이스 연결이 끊어졌을 때(배터리 방전 등) 무한 로그 스팸이 발생하는 문제를 수정했습니다.

**변경 내용** (`screenStreamService.ts`):
- 디바이스 연결 끊김 감지 시 즉시 스트림 중지
- 클라이언트에 `DEVICE_DISCONNECTED` 에러 코드 전송
- 로그 스팸 방지 (첫 번째 오류만 로그)

```typescript
// 디바이스 연결 끊김 감지
if (errorMessage.includes('not found') ||
    errorMessage.includes('offline') ||
    errorMessage.includes('unauthorized')) {
  return 'device_not_found';  // 즉시 스트림 중지 트리거
}
```

---

## 키보드 단축키 요약

| 단축키 | 동작 |
|--------|------|
| Ctrl+A | 모든 노드 선택 |
| Ctrl+C | 선택된 노드 복사 |
| Ctrl+V | 붙여넣기 (단일 선택 시 뒤에 삽입) |
| Ctrl+D | 복제 (원본 옆에 배치) |
| Delete | 선택된 노드 삭제 |
| Escape | 선택 해제 / 검색 닫기 |
| Enter | 검색 결과 첫 번째 선택 |

---

*최종 수정일: 2026-01-29*
